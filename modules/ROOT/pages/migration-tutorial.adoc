= Mule Migration Tool Tutorial
ifndef::env-site,env-github[]
include::_attributes[]
endif::[]

//TODO: FOR GA, REMOVE *Beta* FROM GA VERSION
*Beta Release: Mule Migration tool and Compatibility Module*

This tutorial walks you through the main steps for migrating a Mule 3 app to
Mule 4. It covers use of the Mule Migration tool, the Migration report, and
the Compatibility module.

== Prerequisites

In addition to using the Mule Migration tool, which initiates the migration to
Mule 4, you also need to use two versions of Anypoint Studio. Studio 6 is
compatible with Mule 3.x runtime versions. Studio 7 is compatible with Mule 4.x
runtimes.

If you do not have them already, you can download the Migration tool and
Anypoint Studio applications from these links:

* https://repository.mulesoft.org/nexus/service/local/repositories/releases/content/com/mulesoft/tools/mule-migration-tool-runner/0.3.0/mule-migration-tool-runner-0.3.0.jar[Mule Migration Tool (Jar file)]
* https://mule-studio.s3.amazonaws.com/6.5.1-U1/AnypointStudio-for-macosx-64bit-6.5.1-201810012018.zip[Anypoint Studio 6 (Zip file)]
* https://mule-studio.s3.amazonaws.com/7.3.0-GA/AnypointStudio-for-macosx-64bit-7.3.0-201810191800.zip[Anypoint Studio 7.3.0 (Zip file)]: The minimum requirement is version 7.3.0.

[[step_1]]
== Download and Import a Mule 3 App

You start by downloading a Mule 3 app from Anypoint Exchange, then importing it
into Studio 6. In subsequent sections, you will migrate this app to Mule 4.

image::mmt-exchange.png[Exchange: Querying a MySQL Database]

. Download version 1.4.0 of the https://anypoint.mulesoft.com/exchange/org.mule.examples/querying-a-mysql-database/1.4.0/[Querying a MySQL Database]
asset from Exchange.
+
Note that the 1.4.0 asset is a Mule 3 app that runs on Mule Runtime 3.x. Its
filename is `querying-a-mysql-database-1.4.0-mule-application-example.zip`.
+
. In Studio 6, import the downloaded zip file by going to *File* -> *Import* ->
*Anypoint Studio/Anypoint Studio deployable archive (zip)*, selecting the zip, and
then clicking *Finish*.
+
This process loads the app into a project in Studio 6. By default, the name of
the project matches the zip filename (minus the file extension).
+
. Proceed to <<step_2>>.

[[step_2]]
== Create a Mule 4 App from the Mule 3 App

Now you run the Mule Migration tool on the Mule 3 app and import the migrated
app into Studio 7. In subsequent sections, you will perform the manual steps
needed to complete the migration to Mule 4.

. In a command console:
+
Run the Mule Migration tool, making sure to _revise
the sample directory paths_ set by the `-projectBasePath` and
`-destinationProjectBasePath` options.
+
[source,console,linenums]
----
$ java -jar mule-migration-tool-runner-0.3.0.jar -muleVersion 4.1.3 -projectBasePath /Users/home/AnypointStudio/workspace-studio6/querying-a-mysql-database-1.4.0-mule-application-example -destinationProjectBasePath /Users/me/Downloads/querying-a-mysql-database-mule4
----
+
To discover the `-projectBasePath` to the Studio 6 project, you can navigate
to *File* -> *Switch Workspace* -> *Other* in Studio. To that path, you also
need to append the name of the project, as shown in the example above. The `-destinationProjectBasePath` can be any local path. For details, see xref:migration-tool-procedure.adoc#options[Command-line Options].
+
When the tool runs successfully, the console output looks something like this:
+
[souce,console,linenums]
----
$ ...
Executing migrator 0.3.0...
===============================================================================
MIGRATION TOOL RUN SUCCESSFULLY
===============================================================================
Components migrated successfully:  33 %
Components migrated with errors:    0 %
Total time: 5.326 s
Migration report:
  /Users/me/Downloads/querying-a-mysql-database-mule4/report/summary.html
----
+
. In Studio 7:
+
Import the generated Mule 4 app as a Studio project by going to
*File* -> *Import* ->
*Anypoint Studio/Anypoint Studio project from File System*, loading the
*Project Root* directory that contains the Mule 4 app, and then clicking *Finish*.
+
You can now find the imported app in Studio 7. Its flow looks like this:
+
image::mmt-migrated-app.png[Imported App]
+
. Proceed to <<step_3>>.

[[step_3]]
== Perform Manual Migration Procedures

Now you review the xref:migration-report.adoc[Mule Migration report], fix the
issues it finds, and remove any unnecessary complexity that the tool adds to
the app. For the sample app, the report looks like this:

image::mmt-report.png[Mule Migration Tool Report]


Note that the report identifies items that remain to complete the migration to
Mule 4. The warnings (WARN messages) in this report are associated with
components in the
xref:migration-tool.adoc#compatibility_module[Compatibility module] that you
need to migrate manually before using the app in a production environment.
Reports can also contain errors (ERROR messages) that must be migrated manually
before the app will work. Additionally, a report can contain INFO messages
about Mule 3 components that were replaced by Mule 4 improvements or removed.

. In a web browser, open the Migration report (`summary.html`) produced by the
Migration tool.
+
You can find the path to the report at the bottom of the Migration tool's
console output, for example:
`/Users/me/Downloads/querying-a-mysql-database-mule4/report/summary.html`.
+
. Address warnings and other messages in the report by performing these tasks:
+
* <<warning_1>>
* <<warning_2>>
* <<warning_3>>
* <<warning_4>>
* <<warning_5>>

When you complete the modifications, the flow will look like this:

image::mmt-resulting-flow.png[Flow: Database To JSON]

[[warning_1]]
=== Migrate HTTP Listener Components

In Mule 3, connectors and transports that need to send outbound data must explicitly specify outbound properties, such as outgoing status code responses
or headers for an HTTP listener.

The Migration report produces this warning twice within the *HTTP listener*
component:

[source,txt,linenums]
----
Migration WARN:
Avoid using an outbound property to determine the status code.
----

Because the Mule 3 sample app does not use the `statusCode` outbound property
from the Mule 3 HTTP transport and because no outbound property is set in a
flow, you can safely remove any use of the outbound property in this case.

////
For cases in other apps where you _do_ need to handle a `statusCode`
or outbound property in a flow, it is important to notice that both the
Migration report and the Configuration XML for the migrated app provide links
to specific documentation on performing this migration, in this case to  xref:migration-tool-post-mig.adoc#outbound_properties[Outbound Properties (Manual Post-Migration Steps)].
////

//image::mmt-http-status-code.png[HTTP Status Code Warnings]

. In Studio 7, delete these elements from the Configuration XML for the
migrated app:
+
[source,xml,linenums]
----
<http:response statusCode="#[migration::HttpListener::httpListenerResponseSuccessStatusCode(vars)]">
  <!--Migration WARN: Avoid using an outbound property to determine the status code.-->
  <!--    For more information refer to:-->
  <!--        * https://beta.docs.stgx.mulesoft.com/beta-mule-migration-tool/mule-runtime/4.1/migration-tool-post-mig.html#outbound_properties-->
  <http:headers>#[migration::HttpListener::httpListenerResponseHeaders(vars)]</http:headers>
</http:response>
<http:error-response statusCode="#[vars.statusCode default migration::HttpListener::httpListenerResponseErrorStatusCode(vars)]">
  <!--Migration WARN: Avoid using an outbound property to determine the status code.-->
  <!--    For more information refer to:-->
  <!--        * https://beta.docs.stgx.mulesoft.com/beta-mule-migration-tool/mule-runtime/4.1/migration-tool-post-mig.html#outbound_properties-->
  <http:headers>#[migration::HttpListener::httpListenerResponseHeaders(vars)]</http:headers>
</http:response>
----
+
. To set up a working connection for the listener, specify an
`http:listener-connection` element as a child of `http`, something like this:
+
[source,xml,linenums]
----
<http:listener-config doc:name="HTTP Listener Configuration"
  name="HTTP_Listener_Configuration">
    <http:listener-connection host="localhost" port="8080" />
</http:listener-config>
----
+
If you want to make use of the `{http.port}` placeholder instead, see
xref:mule-app-properties-to-configure.adoc[Configure Property Placeholders for Mule Apps].
+
. Proceed to <<warning_2>>.

[[warning_2]]
=== Migrate the Attributes to Inbound Properties Component

This component reads attributes of the Mule message and generates a Mule 3.x
equivalent of inbound properties as a variable. Any use of an Inbound property
in a migrated app requires you to replace references to an Inbound property
with the Attributes object from the new Mule message. _However_, because there
are no inbound properties in this app
(`querying-a-mysql-database-1.4.0-mule-application-example`), you can safely
remove the *Inbound Properties Component* component from it.

The Migration report produces this warning for the
*Attributes to Inbound Properties* component:

[source,txt,linenums]
----
Migration WARN:
Expressions that query inboundProperties from the message should instead query
the attributes of the message. Remove this component when there are no
remaining usages of inboundProperties in expressions or components that rely
on inboundProperties (such as copy-properties).
----

. Delete the *Attributes to Inbound Properties* component:
+
[source,XML,linenums]
----
<compatibility:attributes-to-inbound-properties>
  <!--Migration WARN: Expressions that query inboundProperties from the message should instead query the attributes of the message. Remove this component when there are no remaining usages of inboundProperties in expressions or components that rely on inboundProperties (such as 'copy-properties').-->
  <!--    For more information refer to:-->
  <!--        * https://docs.mulesoft.com/mule-user-guide/v/4.1/intro-mule-message#inbound-properties-are-now-attributes-->
</compatibility:attributes-to-inbound-properties>
----
+
. Proceed to <<warning_3>>.

[[warning_3]]
=== Migrate Outbound Properties to var Component

The migration report produces this warning for the two
*Outbound Properties to var* components in the flow:

[source,txt,linenums]
----
Migration WARN:
Instead of using outbound properties in the flow, its values must be set
explicitly in the operation/listener.
----

The XML element for the *Outbound Properties to var* component looks like this:

[source,XML,linenums]
----
<compatibility:outbound-properties-to-var>
  <!--Migration WARN: Instead of using outbound properties in the flow,
      its values must be set explicitly in the operation/listener.-->
  <!-- For more information refer to:-->
  <!--  https://beta.docs.stgx.mulesoft.com/beta-mule-migration-tool/mule-runtime/4.1/migration-tool-post-mig.html#outbound_properties-->
</compatibility:outbound-properties-to-var>
----

. To understand this issue, double-click the *Outbound Properties to var* icon
in the Message Flow view, and go to the *Help* tab in the configuration area.
+
image::mmt-outbound-properties-to-var.png[Outbound Properties to var]
+
This note indicates that the component is intended to emulate the use of
outbound properties in a Mule 3 App. Because there are no outbound properties
in the flow, it is safe to remove the components.
. Remove the both *Outbound Properties to var* components
(`<compatibility:outbound-properties-to-var />` elements) from the app.
. Proceed to <<warning_4>>.

[[warning_4]]
== Migrate the Global Database Connection

The Migration report produces this warning for the global connector
configuration element within *Perform a query in MySQL* component:

[source,txt,linenums]
----
Migration WARN:
The config in Mule 3 is specific for an engine, but it contained an 'url'
attribute. It will be made generic in order to keep the url.
----

The Migration tool set the global connector configuration to a *Generic* type
to preserve the `url` attribute used in the Mule 3 app. However, because
the app is using a MySQL database, you can change the global connection type
and its settings to a *MySQL Connection*.

. Double-click the *Perform a query in MySQL* component to open its
configuration tab.
. In the *General* tab, click to edit the *Connector configuration*.
. In the *Connection* field, change the value from *Generic Connection* to
*MySQL Connection*.
+
image::mmt-db-mysql.png[Database Configuration: MySQL Connection]
+
. To add the recommended JDBC driver for this database, click the *Configure*
button and use *Add recommended library* to replace the existing driver.
. If you have access to a MySQL server into which you can import a database, specify your *Connection* settings, and use `company` for the *Database*
setting, for example:
+
image::mmt-db-add-recommended-lib.png[Database Configuration: Add Recommended Libraries]
+
You can skip this step if you do not have access to a MySQL database server.
+
. Proceed to <<warning_5>>, also for the *Perform a query in MySQL* component.

[[warning_5]]
== Migrate the Database Query to Mule 4

The Migration report produces this warning regarding `inboundProperties`
settings within *Perform a query in MySQL* component:

[source,txt,linenums]
----
Migration WARN:
Expressions that query inboundProperties from the message should instead query
the attributes of the message. Remove this component when there are no
remaining usages of inboundProperties in expressions or components that rely
on inboundProperties (such as 'copy-properties').
----

In this procedure, you replace the reference to the inbound property with a
parameter called `:lastname`, then define a `lastName` input parameter as a
reference to `attributes.queryParams.lastName`.

. In the *General* tab of the *Perform a query in MySQL*, delete value of
`last_name` in the Mule 3 SQL *Query*:
+
[source,sql,linenums]
----
#["select first_name from employees where last_name = '$(vars.compatibility_inboundProperties['http.query.params'].lastname)'"]
----
+
. Replace the deleted _value_ of `last_name` with a parameter called `:lastname`:
+
[source,sql,linenums]
----
SELECT first_name FROM employees WHERE last_name = :lastName
----
+
. Specify the following *Input Parameters*:
+
[source,sql,linenums]
----
{'lastName' : attributes.queryParams.lastname}
----
+
image::mmt-db-query.png[Perform A Query in MySQL]
+
. Proceed to <<warning_6>>, also for the *Perform a query in MySQL* component.

[[warning_6]]
== Review the Message on Streaming in Mule 4

Mule 4 handles streaming differently than Mule 3, so the Migration report
produces this message in the *Perform a query in MySQL* component:

[source,txt,linenums]
----
Streaming is enabled by default in Mule 4
----

. Simply review the
xref:migration-connectors-database.adoc#database_streaming[Enabling Streaming]
documentation.
+
You do not need to perform any manual migration tasks in this case.
+
. Proceed to <<warning_7>>.

[[warning_7]]
=== Replace the Convert Object to JSON Component

The Beta version of the Mule Migration tool does not yet support the migration
of the *Object to JSON* component to Mule 4.

To complete the migration, this procedure replaces the *Convert Object to JSON*
transformer with a Transform Message component, sets the output type of the
DataWeave script in the Transform Message component to JSON, and sets the
script to the message `payload`.

. Delete the *Convert Object to JSON* transformer from the flow.
. In the Mule Palette, click *Core*, then locate and drag the
*Transform Message* component to the same location in the flow.
. Double-click the *Transform Message* component to open the configuration area.
. In the *Output* section on the right, replace `application/java` and the
curly braces (`{}`) with `application/json` and `payload`, like this:
+
[source,dataweave,linenums]
----
%dw 2.0
output application/json
---
payload
----
+
The configuration should look like this:
+
image::mmt-dataweave.png[Transform Message]
+
. Go to the Configuration XML view in Studio to verify that there are no
remaining comments that contain WARN messages.
. By the end of the migration, the flow should look like this:
+
image::mmt-resulting-flow.png[Flow: Database To JSON]
+
. Proceed to <<test_app>>.

[[test_app]]
== Run and Test the Migrated App

After completing all the manual migration steps for the app, you can run and
test that it works.

.Prerequisites:
To be able to test the migrated app, you need a MySQL server with the `employees`
database that the app queries, and you need to make sure that your database and
HTTP listener connections work.

. Import this script into your MySQL server:
link:{attachmentsdir}/create.sample.db.sql[Sample MySQL Script]
+
This script creates a database called `company` with an `employees` table that
contains data needed to test the SELECT query defined in <<warning_5>>.
One way to import the script is through the *Data Import/Restore* area of
MySQLWorkbench, using the *Import from Self-Contained File* field to point to
the script.
+
. In Studio, test your *Connection* to the MySQL database.
+
You test the connection from dialog that opens when you click to edit the
*Connector config* in the *Perform a query in MySQL* component.
+
Make sure the connection is successful before proceeding to the next step.
+
. Now test your *Connection* to the HTTP listener from the
*Receive HTTP request* component.
+
Make sure the connection is successful before proceeding to the next step.
+
. Make sure your app is running in Studio.
+
You can right-click the canvas in Studio and select *Run project* to run the app.
+
You need to check the *Console* in Studio to make sure the app deploys
successfully before proceeding to the next step.
+
. In a web browser or app such as Postman, go to URL (such as
  `http://localhost:8080/?lastname=Howard`) that uses your HTTP listener
  configuration, and view the JSON results:
+
[source,json,linenums]
----
[
  {
      "first_name": "Devin"
  },
  {
      "first_name": "Luke"
  }
]
----
+
Notice that the URL includes query parameters defined in the HTTP listener
configuration.

Note that you can also download and import the Mule 4 version of
https://anypoint.mulesoft.com/exchange/org.mule.examples/querying-a-mysql-database/2.1.4/[Querying a MySQL Database app for Mule 4] from Exchange and compare your results.

== See Also

* xref:migration-tool.adoc[Migration to Mule 4]
* xref:7.2@studio::import-export-packages.adoc#importing-projects-to-studio[Importing and Exporting Projects]
